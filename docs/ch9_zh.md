第9 章 LS P :里氏替换原则
1988年 ,Barbara Liskov在描述如何定义产类型时写下了这样一段话:
这里需要的是-种可替换性：如果对于每个类型是$ 的对•家0 ］都存在 
一个类型为T 的对象。2 ,能使操作t 类型的程序p 在用。2 替换。］时行为 保持不变，我们就可以将s 称为T 的子类型，| 为了让读者理解这段话中所体现的设计理念，也就是里氏替换原则(LSP) , 
我们可以来看几个例子。
继承的使用指导
假设我们有一个L ic e n se 类，其结构如图9」 所示。该类中有一个名为 
c a lc F e e ()的方法，该方法将由B illin g 应用程序来调用。而 L ic e n s e 类有两 个 "子 类 型 ” ：P e rs o n a lL ic e n s e 与 B u sin e ssL ic e n s㊀，这两个类会用不同的 
算法来计算授权费用。
图9.1： L icense类与其衍生类，体现了 LSP原则
上述设计是符合LSP原则的，因为B illin g 应用程序的行为并不依赖于其使 用的任何一个衍生类。也就是说，这两个衍生类的对象都是可以用来替换License 
类对象的。
1 请参考 Barbara Liskov 的 Data Abstraction and Hierarchy - 文 , 该文 1 聯 年 ' 月发表于 SIGPLAN
Notices^, 5）。架构整洁之道
正方形/长方形问题
匸方形/长 方 形 问 题 是 个著名
或者说臭名远扬）的违反L S P 的设计案例
User
问题的结构如图9.2所示）。 --- ----
___ __ » Rectangle
下setH, “ g迥 A
Square
-b setSide
图9.2：正方形/长方形问题
在这个案例中，Square类并不是R e c ta n g le类的子类型，因为Rectangle 
类的高和宽可以分别修改，而 Square类的高和宽则必须一同修改。由于User类 始终认为自己在操作R ectangle类,因此会带来一些混淆。例如在下面的代码中:
Rectangle r = .・・ r •setW(5); r.setH (2); assert(r.area () == 10);
很显然,如果上述代码在…处返回的是S q u are类，则最后的这个assert是不 
会成立的。
如果想要防范这种违反LSP的行为，唯一的办法就是在u s e r类中增加用于E 
分R ectangle和 S q u ate的检测逻辑（例如增加i f 语句）。但这样一来，user 
为的行为乂将依赖于它所使用的类，这两个类就不能互相替换r
LSP与软件架构
在面向对象这场编程革命兴起的早期，我们的普遍认知正如上文所说,认为LSP第 9 章 LS P :里氏替换原贝U
只不过是指导如何使用继承关系的」种方法，然ifur-ji nibj-间的推移，lsp逐渐演变 成了一种更广泛的、指导接口与其实现方式的设计原则。
这里提到的接口可以有多种形式—— nJ-以是jav a风格的接口 J 1彳多个实现类； 也可以像Ruby —样，几个类共用一样的方法签名，甚至可以是几个服务响应同一 
个REST接口。
LSP适用于上述所有的应用场景，因为这些场景中的用户都依赖于一种接口， 
并且都期待实现该接口的类之间能具有可替换性。
想要从软件架构的角度来理解LSP的意义，最好的办法还是来看几个反面案例。
违反LSP的案例
假设我们现在正在构建一个提供出租车调度服务的系统。在该系统中，用户可 
以通过访问我们的网站，从多个岀租车公司内寻找最适合自己的岀租车。当用户选 
定车子时，该系统会通过调用wstfid服务接口来调度这辆车。 接下来，我们再假设该estftil调度服务接口的URI被存储在司机数据库中。_ 旦该系统选中了最合适的出租车司机，它就会从司机数据库的记录中读取相应的 
URI信息，并通过调用这个URI来调度汽车。
■
也就是说，如果司机Bob的记录中包含如下调度URL
purplecab.com/driver/Bob
那么，我们的系统就会将调度信息附加在这个U R I 上’并发送这样一个PUT 
请求：
purplecab.com/driver/Bob /pickupAddress/24 Maple St. /pickupTime/153 /destination/ORD架构整洁之道
很显然, 这意味着所存参与该调度服务的公7。祁必须遵 疔同样的只EST接口, 
它们必须用同样的方式处理pickupA ddress. pickupT im e和 d e stin a tio n ^
本
接 F来,我们再假设Acme出租车公司现在招聘的程序员由于没尙仔细阅射 述接口'定义,结果将destination字 段 缩 写 成 了 左 沁 而 Acme又是本地最大的辭 车公司，另外，Acme CEO的前妻不巧还是我们CEO的新欢……你懂的！滋会镌 统的架构造成什么影响呢？
显然, 我们需要为系统增加一类特殊用例，以应对Acme司机的调度请求• 这必须要用另外一套规则来构建。
最简单的做法当然是增加一条if语句:
if (driver.getDispatchUri() .startsWith("acme.com” ))…
然而很明显，任何一个称职的软件架构师都不会允许这样一条语句出现在自己 
的系统中。因为直接将“acme” 这样的字串写入代码会留下各种各样神奇又可怕的 错误隐患，甚至会导致安全问题。
例如，Acme也许会变得更加成功，最终收购了 Purple出租车公司。然后，t 们在保留了各自名字的同时却统一了彼此的计算机系统。在这种情况下，系统中歪 
道还要再增加一条“purple” 的特例吗？
软件架构师应该创建一个调度请求创建组件，并让该组件使用一个配置数据匡
来保存URI组装格式，这样的方式可以保护系统不受外界因素变化的影响。例如亲
配!1! 置信息可以如下:
URI 调度格式
Acme ・ com /pickupAddress/%s/pickupTime/%s/des /pickupAddress/%s/pickupTime/%s/destination/%s
但这样一来，软件架构师就需要通过增加一个复杂的组件来应对并不完全能*
现互相替换的r e s tf u l服务接口。
72口,
本章小结
而
I己 
］的
它 
噬
第9 章 LSP：里氏替换原则
LSP可以且应该被应用丁软件架构层面，因为一旦违背了可替换也该系统架 
构就不得不为此增添大量复杂的应对机制。
库