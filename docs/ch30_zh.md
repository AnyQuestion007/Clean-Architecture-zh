第30章 数据库只是实现袭击

构 中 釁 鶯 需 驚 豎 果 : : 爲 : : ； m ’n 现细节在系统］ 就好比是门把手和幣个枷衆构的［: 小 1 系统架构的关系打个比方，它们之］
护 鳶 黑 豐 警 警 非 议 。相信我,k 种 架 我 吵 如 次 屬 以 我 在 这 硼 :系 豎 豎 丫 尹 疋 很 重 要 的 ’•擴 库 乐 是 数 据 樓 型 。数据库只是-款软 
件：疋 来存取数据的工具。从系统架构的角度来看，工具通常是无关紧要的一 
因为这只是［个底层的实现细节，一种达成目标的手段。一个优秀的架构师是不会 
让实现细节污染整个系统架构的。
关系型数据库
关系型数据库的基本原理是Edgar Codd在 1970年定义的。到了 20世纪80年 代中期，这种关系模型已经成为数据存储设计的主流。由于关系模型优雅、自律、 
非常稳健，因此得到了非常广泛的应用。总之，关系型数据库是一种非常优秀的数 
据存储与访问技术。
但不管关系型数据库的设计有多么有智慧，多么精巧，多么符合数学原理，它 
仍然也只是一种技术。换句话说，它终究只是一种实现细节。
虽然关系型数据的表模型设计对某一类数据访问需要来说可能很方便，但是把 
数据按彳;组成表结构本身并没有什么系统架构意义上的重要性。应用程序的用例 
不应该知道，也不应该关心这么低层次的实现细节，需要了解数据表结构的代码应 
该被局限在系统架构的最外圈、最低层的工具函数中。
很多数据访问框架允许将数据彳J和数据衣以対象的形式在系统内部传递。这么 
做在系统架构上来说是完全错误的，这会导致程序的用例、业务逻辑、甚至UI与数 
据的关系模型相互绑定在一起。架构整洁之道
为什么数据库系统如此流彳亍
为什么数据库系统在软件系统和企业软件领域如此流行？ Oracle、MySQL和 SQL Server这些产品广泛流行的原因是什么？答案是硬盘。
带有高速旋转的盘片，以磁感应方式读取数据的硬盘在过去五十年成为数据存 
储的主流手段，以至于最近几代软件工程师对其他类型的数据存储几乎一无所知。 
而且硬盘技术一直在发展，早先一大摞重达数吨的直径48英寸的盘片只能存储20 
兆字节，现在单个直径3 英寸、重量仅仅几克的薄薄的一张硬盘就能存储上TB的 
数据。这发展得实在是太快了！但是在硬盘的整个发展过程中，程序员们始终被一 
个限制困扰着：磁盘的访问速度太慢了！
在磁盘上，数据是按照环形轨道存储的。这些轨道又会进一步被划分成一系列 
扇区，这些扇区的大小通常是4 KB。而每个盘片上都有几百条轨道，整个硬盘可能
由十几个盘片组成。如果要从硬盘上读取某一个特定字节，需要将磁头挪到正确的 
轨道上，等待盘片旋转到正确的位置上，再将整个扇区读入内存中，从内存中查询 
对应的字节。这些过程当然需要时间，所以硬盘的访问速度一般在毫秒级
耄秒级的速度看起来好像并不是很慢，但这已经比大多数处理器的速度慢一百 
万倍了。如果数据不在硬盘上，访问速度通常就通常是纳秒级，而不是毫秒级了。
为了应对硬盘访问速度带来的限制，必须使用索引、缓存以及查询优化器等技
术。同时，我们还需要-种数据的标准展现格式，以便让索引、缓存及查询优化器 
来使用。概括来说，我们需要的就是某种数据访问与管理系统。过去几十年内，业
界逐渐发展出了两种截然不同的系统: 文件系统与关系型数据库系统（RDBMS） o 文件系统疋基十文档格式的，它提供的是一种便于存储整个文档的方式。当需 
要扌女照名字存储数扌居和金找-系列文档时，文件系统很有用，但当我们需要检索文 
档内容时，它就没那么有用了。也就是说，我们在文件系铀■查找一个名字为 
鬥 in .c 的文件很容易，但要检索出所有包括变量山， 文件就很困难，速度也
242炸 EIU S应爲畀爲
种系-充取-、都不将数据缓存在内存中，方便快速操作。
假设磁盘不存在会怎样
虽然硬盘现在还是很常见，但其实已经在走下坡路了。很快它们就会和磁带、 
软盘、CD —样成为历史，RAM正在替代一切。
现在，我们要来考虑一下：如果所有的数据都存在内存中，应该如何组织它们 
呢？需要按表格存储并且用SQ L查询吗？需要用文件形式存储，然后按目录查找 
吗？
当然不，我们会将数据存储为链表、树、哈希表、堆栈、队列等各种各样的数 
据结构，然后用指针或者引用来访问这些数据一因为这对程序员来说是最自然的 
方式。
事实上，如果你再仔细想想，就会发现我们已经在这样做了。即使数据保E 任 
数据库或者文件系统中，我们最终也会将其读取到内存中，并按照取方便的形式将 
其组织成列表、集合、堆栈、队列、树等各种数据结构，继续按文件和表格的形式 
来操作数据是非常少见的。
实现细节
上面所说的,
I I I
聊库只是一种实现细节的原因。数据库终 
-种手段而已，它貞•的对以被认为只是1 
甬甘，岸不△真的以这种形式来使用数据。
243架构整洁之道
因此，从系统架构的视角來看,
么样的格式存在。实际上，系统架构应该对磁盘本身的存在完全不关心。
但性能怎么办呢
性能难道不是系统架构的一个考量标准吗？当然是—— 但当问题涉及数据存储 
时，这方面的操作通常是被封装起来，隔离在业务逻辑之外的。也就是说，我们确 
实需要从数据存储中快速地存取数据，但这终究只是一个底层实现问题。我们完全 
可以在数据访问这一较低的层面上解决这个问题，而不需要让它与系统架构相关联。
一段轶事
在 20世纪80年代末，我曾在一家创业公司中带领一组软件工程师开发和推广
一个用于监控T1线路通信质量的网络管理系统。该系统从T1线路两端的设备抓取 
数据‘然后利用预测算法来检测和汇报问题。
我们当时采用的是UNIX平台，并将数据存储成简单的可随机访问的格式。该 
项目当时也不需要用到关系型数据库，因为数据之间几乎没有内容之间的关系，用 
树以及链表的形式来存储数据就够了。简单来说，我们的数据存储格式是为了便于 
加载到内存中处理而设计的。
创业公司后来招聘了一个市场推广经理 他人很好，知识也很全面。然而他 
告诉我的第一件事就是我们系统中必须有一个关系型数据库。这容不得商量，也不 
是一个工程问题—— 而是一个市场问题。
这对我来说很难接受，为什么我要将链表和树重新按照表格与行模式重组，并 
且用SQL方式存储呢？为什么我们要在随机访问文件系统已经足够用的情况下引入 
大型关系型数据库系统？所以我一直和他针锋相对，互不相让。
244第30童 数据库只是实现细节
缔 ; ; 川帅被、藕型数据库大潮所感染,他坚信我们的糾 
板 豐 支 撑 的 房 & 问 道： 卿会把房子建在几根杆子搭疽易的 
地基上• 3 后呢辑思通过关系型数据库将数据存储于文件系统中，在某种 
程度上要比我们自己存储这些文件更可靠.
我当然没有放弃，—直不停地和他还有市场部斗争到底。我誓死捍卫了自己的 
工程原则，不停地开会、斗争。
最终，这位硬件工程师被提拔为软件开发经理，最终，系统中也加入了一个关 
系型数据库。最终，我不得不承认，他们是对的，而我是错的。
但这里说的不是软件工程问题：在这个问题上我仍然坚持自己没有错，在系统 
的核心架构中的确不应该引入关系型数据库。这里说我错了的原因，是因为我们的 
客户希望该系统中能有一个关系型数据库。他们其实也不知道为什么需要，因为他 
们自己是没有任何机会使用这个关系型数据库的。但这不是重点，问题的重点是我 
们的客户需要一个关系型数据库。它已经成为当时所有软件购买合同中的一个必选 
项。这背后毫无工程逻辑一一是不理智的。但尽管它是不理智的、外行的、毫无根 
基的需求，但却是真实存在的。
这种需求是从哪里来的？其实是来自于当时数据库厂商非常有效的市场推广。 
他们说服了企业高管，他们的“数据资产”需要某种保护，数据库则提供了非常便 
捷的保护能力。
直到今天我们也能看到这种市场宣传，譬如“企业级 面向服务的架构这 
样的措辞大部分都是市场宣传噱头，而跟实际的工程质量无关。
回头棹棹，我在这个场景中应该怎么做呢？事实上’我钿应该在系统的八 
角 山 ;二 关 ;:数 据 库 ，在维持系统核心数据结构f 管 系 常 库 響 —些安全的、受限的数据访问方式。但我没这么做’我辞职了’干起」咨询这一仃。本章小结
数据的组织结构，
数据的模型，都是系统架构中的重要部分，但是从磁盘上
并且以SQL访问，主要是为了后者。总而言之，数据本身很重要, 
仅是一个实现细节。第34章
Web是实现细节架构整洁之道
心卄纪90年代的时候，你己经是程序员了吗？还记得叭是如何改变-切的 
吗？你记得我们在有了崭新的Web技术之后，是如何鄙视那些老旧的客户端/服务器
回
架构的吗？
然而，Web技术事实上并没有改变任何东西，或者迂豐赞力改变任何东 
西。这 -次 Web热潮只是软件行业从1960年来经历的数/人「 宀、' ~次°这些振 
荡-会儿将全部计算资源集中在中央服务器上，-会儿又将计算资源分散到各个终 
端上。
事实上，在过去十年内，或者说自Web技术被普遍应用以来，这样的振荡也发 
生了几次。一开始我们以为计算资源应该集中在服务器集群中，浏览器应该保持简 
单。但随后我们又开始在浏览器中引入Applets-再后来我们又改了主意,发明了 Web 2.0,用 Ajax和 JavaScript将很多计算过程挪回浏览器中。我们先是非常兴奋地 将整个应用程序挪到浏览器去执行，后来又非常开心地 采 用 Node技术将那些 JavaScript代码挪回服务器上执行。 一声叹息!
无尽的钟摆
当然，这些振荡也不是从Web技术开始的。在 Web岀现之前，这种振荡在客户 端/服务器架构中就很普遍。再往前，就是中央小型机/瘦终端的模型（这里的瘦终端 
和现在我们所谓的现代浏览器非常相似）。再往前则是大型计算机与打孔卡...
而冃这样的故事还会继续下去，我们似乎永远也决定不了应该将计算资源放在
哪里。我们不停地在集中式和分布式之间来回切换。看起来, 
续一段时间。；
这样的振荡还要再持
但从IT技术发展历史的整体来看，我们会发现⑷小技术的出现并没有改变任 
何东西。Web技术的热潮只是在这个早于我们出生，也肯定会超过我们职业生涯的 振荡周期中的一瞬间。