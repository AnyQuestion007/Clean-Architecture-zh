第27章
服务：宏观与微观
/ V #1 1 1面向服务的“架构”以及微服务“架构”近年来非吊流行，其中的原因如卞， 
■ 服务之间似乎是强隔离的，但是下文我们会讲到，并不完全是这样。
•服务被认为是支持独立开发和部署的，同样，下文我们也会讲到，并不完全 
是这样。
面向服务的架构
首先，我们来批判“只要使用了服务，就等于有了一套架构”这种思想。这显 
然是完全错误的。如前文所述，架构设计的任务就是找到高层策略与低层细节之间 
的架构边界，同时保证这些边界遵守依赖关系规则。所谓的服务本身只是一种比函 
数调用方式成本稍高的，分割应用程序行为的一种形式，与系统架构无关。
当然，这里并不是说所有的服务都应该具有系统架构上的意义。有时候，用服 
务这种形式来隔离不同平台或进程中的程序行为这件事本身就很重要—— 不管它们 
是否遵守依赖关系规则。我们只是认为，服务本身并不能完全代表系统架构。
为了帮助读者理解上面所说的区别，我们用函数的组织形式来做个类比。不管 
是单体程序，还是多组件程序，系统架构都是由那些跨越架构边界的关键函数调用 
来定义的，并且整个架构必须遵守依赖关系规则。系统中许多其他的函数虽然也起 
到了隔离行为的效果，但它们显然并不具有架构意义。
服务的情况也-样，服务这种形式说到底不过是—种跨进程/平台边界的函数调 
用而己。有些服务会具有架构上的意义，有些则没有。我们这里重点要讨论的，当 
然是前者。
擊」
服务所带来的好处
来批驳。
210第27章 服 务 ：宏观与微观
解耦合的谬论
很多人认为将系统拆分成服务的•个最忙要的好处就見讣每个服务Z 间实现强 
解耦。毕會每个服务都是以1 个不同的进程来运行的，甚至运輝在不約处理器 
上。因此,服务之间通常不能访问彼此的变量。其外，服务之间的接【| ■定是充分 
定义的。
从一定程度上来说，这是对的。确实，服务z 间的确在变量层面做到了彼此隔 离。然而，它们之间还是可能会因为处理器内的共享资源，或者通过网络共皐资源 
而彼此耦合的。另外，任何形式的共享数据行为都会导致强耦合。
例如, 如果给服务之间传递的数据记录中增加了一个新字段，那么每个需要操
作这个字段的服务都必须要做岀相应的变更，服务之间必须对这条数据的解读达成 
-致。因此其实这些服务全部是强耦合于这条数据结构的，因此它们是间接彼此耦
合的。
再来说说服务能很好地定义接口 它确实能很好地定义接口 但函数也能
做到这一点。事实上，服务的接口与普通的函数接口相比，并没有比后者更止式、
更严谨，也没有更好，这一点根本算不上什么好处。
独立开发部署的谬论
人们认为的另一个使用服务的好处就是’不同的服务可以由不同的专门团队负 
责和运维。这让开发团队可以釆用dev・ops混合的形式来编写、维护以及运维各自 g 服务:这种开发和部署上的独立性被认为是可扩展的。这种观点认为大型系统可 以由几;个、几百个、甚至几千个独立开发部署的服务组成。整个系统的研发、维
这种理令有_ 些道理一 但也仅仅是一些而已。首先，无数丿力史事实址明，大 
型系统-样可以釆用单体模式，或打组件模式来构建，不一定非得服务化。因此服 
务化并不是构建大型系统的唯一选择。
■ I ・ ■
211它们的开发、部署和运维也必须彼此协调来进行。
运送猫咪的难题
下面，我们再以Z 前那个出租车调度系统为例来说明上面那两个谬论。各位还 
记得吗？该系统会负责统一调度给定城市中的多个出租车提供商，而用户可以集中 
在它那里下订单。在这里，我们假设用户在租车时往往会附带一组参考条件，例如 
接送时间、价格、豪华程度、司机的经验，等等。
我们希望整个系统是可扩展的，于是该系统大量采用了微服务架构。然后，我 
们进一步将整个研发团队划分为许多个小团队，每个团队都负责开发、维护和运维 
相应的小数量1的微服务。
这个虚构系统的架构如图27.1所示，整个系统都是依靠服务来构建的。Taxiui 服务负责与用户打交道，用户会通过移动设备向它下订单。TaxiFinder服务负责 调用不同的TaxiSupplier服务来获取可用车辆的信息，并且找出可用的出租车 
以作为可推荐项。这些可推荐项会短期地被固化成一条数据记录，与用户信息挂钩。
TaxiSelector服务则负责根据用户所选择的价格、时间、豪华程度等条件从可选 
项中筛选结果，最后这些结果会被传递给TaxiDispatcher服务，由它负责分派 
订单。 
" 、、
图27」：出租车调度系统的服务架构图
1 因此微服务的总数量应与程序员的数量大致相同。
212第 27章 服 务 ：宏观与微观
器 臂 运 小 年 有 余 。其 研 发 团 瞥 持 " 功 T
O
在- 个阳光明媚的早上，市场部召集整个研发部开会。会议匕市场部宣布了 
他们在该城市升展猫咪送达服务的计划。该计划将允许用户向系统卜•订单，要求将 
他们的猫咪送到自己家里或者办公室C
公司的计划是在城市中建立几个猫咪集散点。当用户下订单时，附近的-辆出 
租车将被选中去集散点取猫，并将猫送到指定地点。
现在已经有一家出租车公司参加了这项活动，未来可能还会有其他公司参与进 
来，但肯定也会有不参与的公司。
当然，由于有些司机会对猫过敏，所以系统还必须要避免选中这些人去运送猫 
咪。同样的，由于出租车的乘客中也会有对猫过敏的人，所以当他们叫车时，系统 
也必须避免指派过去三天内运送过猫咪的车。
现在根据上述需求再来看我们的系统架构图，数一数有多少个服务需要变更？ 
答案是全部！显然，为了增加这个运送猫咪的功能，该系统所有的服务都需要做变 
更，而且这些服务之间还要彼此做好协调。
换句话说，这些服务事实上全都是强耦合的，并不能真正做到独丄开发、部署 
和维护。
这就是所谓的横跨型变更(cross-cutting c o n c e rn )^ ，三 是 鸞 驚 幕 驚 
要面对的问题，无论服务化还是非服务化的。其中’图27」所加的运种按功牝切分 
器 體 构 方 式 ，在跨系统的功能变更时是最脆弱的。
对象化是救星
仔细囂采常叱I E 席 豐 曲 黑
需要。
213架构整洁之道
这种策略下的系统架构如图27.2所示，我们可以看到该图中的类与图27.1中的 
服务大致是相互对应的。然而，请读者注意这里设置了架构边界，并且遵守了依肺 
关系原则。 
人
现在，原先服务化设计中的大部分逻辑都被包含在对象模型的基类中。然而， 
针对每次特定行程的逻辑被抽离到一个单独的R ides组件中。运送猫咪的新功能被 放入到K itte n s组件中。这两个组件覆盖了原始组件中的抽象基类，这种设计模 式被称作模板方法模式或策略模式。
同时，我们也会注意到R ides和K itte n s这两个新组件都遵守了依赖关系原 则。另外， 
、
实现功能的类也都是由UI控制下的工厂类创建岀来的。
显然，如果我们在这种架构下引入运送猫咪的功能，T axiU I组件就必须随之 变更，但其他的组件就无须变更了。这里只需要引入一个新的jai■文件或者Gem、 DLL。系统在运行时就会自动动态地加载它们。
这样一来，运送猫咪的功能就与系统的其他部分实现了解耦，可以实现独立开 
发和部署了。
S27.2：采用面向对象的方法来处理横跨型变更第 27章 服 务 ：宏观与微观
基于组件的服务
那么，冋题来了：服务化也可以做到这-点吗？答案是肯定的。服务并不-定 
必须是小型的单体程序。服务也可以按照SOLID原则来设计，按照组件结构来部署, 
这样就可以做到在添加/删除组件时不影响服务中的其他组件。
我们可以将Java中的服务看作是一个或多个jar文件中的一组抽象类，而每个 新功能或功能扩展都是另一个jar文件中的类，它们都扩展了之前jar文件中的抽象 类。这样一来，部署新功能就不再是部署服务了，而只是简单地在服务的加载路径 
下增加一个jar文件。换句话说，这种增加新功能的过程符合开闭原则（OCP） o 这种服务的架构如图27.3所示。我们可以看到，在该架构中服务仍然和之前
样，但是每个服务中都增加了内部组件结构，以便使用衍生类来添加新功能，而这 
些衍生类都有各自所生存的组件。
rf Ride K itty
I
Supplier I Supplier
Taxi U1
Taxi Dispatcher
Candidate Taxit
Ride D ispatcher S e le c to r
航 和 越 而 鬲 自 己 内 部 的 组 件 结 构 ，允许以衍生类的方式为其添加臟能
Tax^SupgUerl
血 Supplicr3
Taxi Finder
Ride Finder
K itty Finder
Taxi Selector
K itty S e le c to r
K itty Dispatcher
215横跨型变更
现在我们应该已经明白了，系统的架构边界事实上并不落在服务之间，而是穿 
透所有服务，在服务内部以组件的形式存在。
为了处理这个所有大型系统都会遇到的横跨型变更问题，我们必须在服务内部 
采用遵守依赖关系原则的组件设计方式，如图27.4所示。总而言之，服务边界并不 
能代表系统的架构边界，服务内部的组件边界才是。
图27.4：服务内部的组件的设计必须符合依赖指向规则
本章小结
虽然服务化可能有助于提升系统的可扩展性和可研发性，但服务本身却并不能 
代表整个系统的架构设计。系统的架构是由系统内部的架构边界，以及边界之间的 
依赖关系所定义的，与系统中各组件之间的调用和通信方式无关。
一个服务可能是一个独立组件，以系统架构边界的形式隔开。一个服务也可能 
由几个组件组成，其中的组件以架构边界的形式互相隔离。在极端情况下客户端 
和服务端甚至可能会由于耦合得过于紧密而不具备系统架构意义上的隔离性。
1 我们希望这是极端情况，但不幸的是事实上很常见。